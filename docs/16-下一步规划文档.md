# 下一阶段开发规划文档

> **创建时间**: 2026年1月7日
> **规划周期**: 未来 2-4 周
> **基于文档**: 业务流程检查报告、技术债务报告、之前的规划文档
> **制定人**: Claude Code

---

## 📋 执行摘要

### 当前项目状态

**已完成功能** (约 70% 完成度):
- ✅ 前端核心页面：首页、搜索页、活动列表、活动详情、报名表单
- ✅ 前端核心功能：活动浏览、搜索、报名流程、同行人员添加
- ✅ 双主题适配：所有页面支持浅色/暗黑模式
- ✅ 退出逻辑：智能退出提醒、防误操作
- ✅ Mock 数据系统：所有接口均有 Mock 实现

**主要问题**:
- ❌ **阻塞上线**: 后端 API 全部未开发（P0）
- ❌ **阻塞上线**: 微信登录鉴权未实现（P0）
- ⚠️ **影响体验**: 报名列表筛选功能不完整（P1）
- ⚠️ **影响体验**: 缺少评论/评分功能（P1）
- ⚠️ **影响体验**: "我的活动"页面未开发（P1）
- ⚠️ **技术债务**: 测试覆盖率极低 < 5%（P0）
- ⚠️ **技术债务**: TypeScript `any` 滥用 150+ 处（P1）

### 规划目标

**核心目标**: 在 4 周内完成可上线的 MVP 版本

**关键指标**:
- 后端 API 开发完成度: 100%
- 微信登录鉴权完成度: 100%
- 核心业务流程测试通过率: 100%
- 测试覆盖率: 从 < 5% 提升至 50%+
- TypeScript `any` 使用次数: 从 150+ 降至 < 50

---

## 🎯 优先级原则

### P0 - 阻塞上线 (必须完成)
1. **后端 API 开发** - 无真实 API 无法上线
2. **微信登录鉴权** - 无法识别用户身份
3. **核心业务测试** - 保障功能稳定性

### P1 - 影响用户体验 (建议完成)
1. **评论/评分功能** - 用户反馈渠道
2. **我的活动页面** - 用户查看报名记录
3. **报名列表筛选** - 提升搜索效率
4. **业务错误处理** - 报名截止、名额已满等场景

### P2 - 功能完善 (可延后)
1. **草稿保存** - 防止数据丢失
2. **列表缓存** - 提升加载速度
3. **表单 UI 优化** - 弹窗高度、圆角等细节

### P3 - 优化改进 (有时间再做)
1. **性能优化** - useMemo/useCallback、虚拟滚动
2. **TypeScript 类型完善** - 消除 `any` 类型
3. **代码重构** - 组件复用、逻辑解耦

---

## 📅 四周详细规划

## 第一周 (Week 1): 解决阻塞问题 - P0 优先

### 目标: 打通后端 API + 微信登录

#### D1 - 后端 API 开发（第 1 天）

**任务**: 活动相关接口

| 任务编号 | 任务名称 | 接口 | 优先级 | 预估工时 | 负责人 |
|---------|---------|------|--------|---------|--------|
| W1-D1-T1 | 活动列表接口 | `GET /api/v1/activities` | P0 | 2h | 待定 |
| W1-D1-T2 | 活动详情接口 | `GET /api/v1/activities/:id` | P0 | 1.5h | 待定 |
| W1-D1-T3 | 热门精选接口 | `GET /api/v1/activities/featured` | P0 | 1h | 待定 |
| W1-D1-T4 | 搜索接口 | `GET /api/v1/activities?keyword=xxx` | P0 | 1.5h | 待定 |

**验收标准**:
- [ ] 接口返回数据结构与前端 Mock 数据一致
- [ ] 支持分页参数 `page`、`per_page`
- [ ] 支持筛选参数 `status`、`city`、`keyword`
- [ ] 错误处理完善（404、500 等）

**依赖**:
- 数据库表 `activities` 已创建
- 需要补充字段: `city`, `is_free`, `price`, `agenda`, `avg_rating`, `signup_count`

---

#### D2 - 后端 API 开发（第 2 天）

**任务**: 报名相关接口

| 任务编号 | 任务名称 | 接口 | 优先级 | 预估工时 | 负责人 |
|---------|---------|------|--------|---------|--------|
| W1-D2-T1 | 报名提交接口 | `POST /api/v1/registrations` | P0 | 3h | 待定 |
| W1-D2-T2 | 同行人员接口 | `POST /api/v1/signups/:id/companions` | P0 | 2h | 待定 |
| W1-D2-T3 | 微信手机号解密 | `POST /api/v1/wechat/decrypt-phone` | P0 | 1.5h | 待定 |

**验收标准**:
- [ ] 报名提交成功返回 `registration_id`
- [ ] 支持完整表单数据 (personal/payment/accommodation/transport)
- [ ] 同行人员关联到主报名记录
- [ ] 微信手机号解密成功返回明文手机号

**依赖**:
- 数据库表 `signups`、`companions` 已创建
- 微信小程序配置 `appid`、`secret`

---

#### D3 - 微信登录鉴权（第 3 天）

**任务**: 微信登录 + JWT 鉴权

| 任务编号 | 任务名称 | 接口 | 优先级 | 预估工时 | 负责人 |
|---------|---------|------|--------|---------|--------|
| W1-D3-T1 | 微信登录接口 | `POST /api/v1/auth/wechat/login` | P0 | 3h | 待定 |
| W1-D3-T2 | JWT Token 刷新 | `POST /api/v1/auth/refresh` | P0 | 2h | 待定 |
| W1-D3-T3 | 前端登录流程 | 微信授权 + Token 存储 | P0 | 2h | 待定 |

**验收标准**:
- [ ] 微信登录成功返回 `access_token` 和 `refresh_token`
- [ ] Token 过期后自动刷新（拦截器实现）
- [ ] 前端存储 Token 到本地（Taro.setStorageSync）
- [ ] 未登录时自动跳转登录页

**依赖**:
- 微信小程序已配置 `appid`、`secret`
- 后端已实现 JWT 签发和验证

**技术方案**:
```typescript
// 前端 services/auth.ts
export const wxLogin = async () => {
  const { code } = await Taro.login()
  const response = await api.post('/auth/wechat/login', { code })
  const { access_token, refresh_token } = response.data
  Taro.setStorageSync('access_token', access_token)
  Taro.setStorageSync('refresh_token', refresh_token)
  return response.data
}

// 前端 services/http.ts - Token 刷新拦截器
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true
      const refreshToken = Taro.getStorageSync('refresh_token')
      const response = await axios.post('/auth/refresh', { refreshToken })
      const { accessToken } = response.data
      Taro.setStorageSync('access_token', accessToken)
      originalRequest.headers['Authorization'] = `Bearer ${accessToken}`
      return api(originalRequest)
    }
    return Promise.reject(error)
  }
)
```

---

#### D4 - 互动接口开发（第 4 天）

**任务**: 收藏/点赞/分享接口

| 任务编号 | 任务名称 | 接口 | 优先级 | 预估工时 | 负责人 |
|---------|---------|------|--------|---------|--------|
| W1-D4-T1 | 收藏接口 | `POST/DELETE /api/v1/engagements/:id/favorite` | P1 | 1.5h | 待定 |
| W1-D4-T2 | 点赞接口 | `POST/DELETE /api/v1/engagements/:id/like` | P1 | 1.5h | 待定 |
| W1-D4-T3 | 分享记录接口 | `POST /api/v1/engagements/:id/share` | P1 | 1h | 待定 |
| W1-D4-T4 | 互动数据查询 | `GET /api/v1/activities/:id/engagement` | P1 | 1h | 待定 |

**验收标准**:
- [ ] 收藏/点赞支持 Toggle（已收藏再次点击取消）
- [ ] 分享记录支持渠道参数（wechat/moments/link）
- [ ] 返回互动数据（收藏数、点赞数、分享数）

---

#### D5 - 前后端联调（第 5 天）

**任务**: Mock 数据切换 + 测试

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W1-D5-T1 | 切换 Mock 模式为关闭 | P0 | 0.5h | 待定 |
| W1-D5-T2 | 测试活动浏览流程 | P0 | 1h | 待定 |
| W1-D5-T3 | 测试报名提交流程 | P0 | 1.5h | 待定 |
| W1-D5-T4 | 测试互动功能 | P1 | 1h | 待定 |
| W1-D5-T5 | 修复联调 Bug | P0 | 2h | 待定 |

**验收标准**:
- [ ] `CONFIG.USE_MOCK = false` 后所有接口正常
- [ ] 完整流程测试通过（浏览 → 详情 → 报名 → 成功）
- [ ] 收藏/点赞/分享功能测试通过
- [ ] 错误提示正常显示（网络错误、业务错误）

**配置文件修改**:
```typescript
// config/index.ts
export const CONFIG = {
  USE_MOCK: false,  // ✅ 关闭 Mock 模式
  API_BASE_URL: process.env.API_BASE_URL || 'https://your-api-domain.com/api/v1',
}
```

---

### 第一周总结

**关键产出**:
- ✅ 后端 API 全部开发完成 (9 个核心接口)
- ✅ 微信登录鉴权实现
- ✅ 前后端联调通过
- ✅ Mock 数据切换为真实 API

**风险点**:
- ⚠️ 微信小程序配置可能需要时间（需提前准备）
- ⚠️ 后端开发可能超时（建议并行开发）

---

## 第二周 (Week 2): 完善核心功能 - P1 优先

### 目标: 评论/评分 + 我的活动 + 业务错误处理

#### D6-D7 - 评论/评分功能（第 6-7 天）

**任务**: 活动详情页评论 Tab + 评分系统

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W2-D6-T1 | 后端评论接口 | P1 | 3h | 待定 |
| W2-D6-T2 | 后端评分接口 | P1 | 2h | 待定 |
| W2-D7-T1 | 前端评论列表组件 | P1 | 3h | 待定 |
| W2-D7-T2 | 前端评分组件 | P1 | 2h | 待定 |
| W2-D7-T3 | 集成到活动详情页 | P1 | 1.5h | 待定 |

**后端接口设计**:

```python
# 1. 获取评论列表
GET /api/v1/activities/:id/comments
Query: page, per_page, sort_by (newest/rating_desc)
Response: {
  "items": [
    {
      "id": 1,
      "user": {"name": "张三", "avatar": "..."},
      "rating": 5,
      "content": "活动很棒！",
      "created_at": "2026-01-05T10:00:00Z",
      "replies": []
    }
  ],
  "total": 100,
  "avg_rating": 4.5
}

# 2. 发布评论
POST /api/v1/activities/:id/comments
Body: {
  "rating": 5,  # 1-5 星
  "content": "活动很棒！",
  "parent_id": null  # 回复评论时使用
}

# 3. 删除评论
DELETE /api/v1/comments/:id
```

**前端 UI 设计**:

```
┌─────────────────────────────────────┐
│ 活动详情页 - 评论 Tab               │
├─────────────────────────────────────┤
│ 综合评分：4.5 ⭐⭐⭐⭐⭐ (215人)   │
│ ┌───────────────────────────────┐   │
│ │ 5星 ████████████ 150 (70%)    │   │
│ │ 4星 ████         40  (18%)    │   │
│ │ 3星 ██           15  (7%)     │   │
│ │ 2星 █            5   (2%)     │   │
│ │ 1星 █            5   (2%)     │   │
│ └───────────────────────────────┘   │
│                                     │
│ [我要评价]                          │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 👤 张三  ⭐⭐⭐⭐⭐  2天前       │ │
│ │ 活动很棒！内容充实，老师讲得  │ │
│ │ 很好，学到了很多知识。        │ │
│ │ [👍 12] [💬 回复]               │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 👤 李四  ⭐⭐⭐⭐   5天前       │ │
│ │ 组织得很好，酒店环境不错...   │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**验收标准**:
- [ ] 评论列表展示（头像、姓名、评分、内容、时间）
- [ ] 评分统计图（星级分布柱状图）
- [ ] 发布评论（星级选择 + 文本输入）
- [ ] 评论排序（最新/评分高低）
- [ ] 分页加载（上拉加载更多）
- [ ] 双主题适配

---

#### D8-D9 - 我的活动页面（第 8-9 天）

**任务**: "我的"页面 - 我的报名列表

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W2-D8-T1 | 后端我的报名接口 | P1 | 2h | 待定 |
| W2-D8-T2 | 后端报名详情接口 | P1 | 1.5h | 待定 |
| W2-D9-T1 | 前端我的报名列表页 | P1 | 3h | 待定 |
| W2-D9-T2 | 前端报名详情弹窗 | P1 | 2h | 待定 |
| W2-D9-T3 | 状态筛选 + 搜索 | P1 | 1.5h | 待定 |

**后端接口设计**:

```python
# 1. 我的报名列表
GET /api/v1/users/me/signups
Query: status (pending/approved/rejected), page, per_page
Response: {
  "items": [
    {
      "id": 1,
      "activity": {
        "id": 10,
        "title": "2025暑期培训会",
        "cover_url": "...",
        "start_time": "2025-08-10T09:00:00Z"
      },
      "status": "approved",  # pending/approved/rejected
      "created_at": "2026-01-05T10:00:00Z",
      "reviewed_at": "2026-01-06T14:00:00Z",
      "personal": {"name": "张三", "phone": "138****0000"}
    }
  ],
  "total": 10
}

# 2. 报名详情
GET /api/v1/signups/:id
Response: {
  "id": 1,
  "activity": {...},
  "status": "approved",
  "personal": {"name": "张三", "school": "XX大学", ...},
  "payment": {"invoice_title": "...", ...},
  "accommodation": {...},
  "transport": {...},
  "companions": [...]  # 同行人员列表
}
```

**前端 UI 设计**:

```
┌─────────────────────────────────────┐
│ 我的                               │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 👤 张三              [编辑]     │ │
│ │ XX大学 | 已报名 5 个活动         │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌───────────────────────────────┐   │
│ │ 活动 | 徽章 | 通知 | 设置     │   │
│ │ ────                          │   │
│ └───────────────────────────────┘   │
│                                     │
│ ┌─── 状态筛选 ───────────────────┐  │
│ │ [全部] [待审核] [已通过] [已拒绝]│ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 2025暑期培训会                  │ │
│ │ 长沙 | 2025-08-10 09:00         │ │
│ │ ✅ 已通过 | 报名时间: 01-05     │ │
│ │ [查看详情]                      │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 春季学术研讨会                  │ │
│ │ 北京 | 2025-04-15 09:00         │ │
│ │ ⏳ 待审核 | 报名时间: 01-03     │ │
│ │ [查看详情]                      │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**验收标准**:
- [ ] 报名列表展示（活动信息、状态、时间）
- [ ] 状态筛选（全部/待审核/已通过/已拒绝）
- [ ] 点击查看详情（弹窗显示完整报名信息）
- [ ] 显示同行人员列表
- [ ] 支持搜索活动名称
- [ ] 双主题适配

---

#### D10 - 业务错误处理（第 10 天）

**任务**: 报名截止、名额已满等业务场景处理

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W2-D10-T1 | 后端补充字段 | P1 | 1h | 待定 |
| W2-D10-T2 | 前端活动状态检查 | P1 | 2h | 待定 |
| W2-D10-T3 | 前端重复报名检查 | P1 | 1.5h | 待定 |
| W2-D10-T4 | 统一错误码处理 | P1 | 1.5h | 待定 |

**后端字段补充**:

```sql
-- activities 表补充字段
ALTER TABLE activities ADD COLUMN signup_deadline TIMESTAMP;
ALTER TABLE activities ADD COLUMN max_participants INTEGER;
ALTER TABLE activities ADD COLUMN current_participants INTEGER DEFAULT 0;
ALTER TABLE activities ADD COLUMN allow_signup_during_event BOOLEAN DEFAULT FALSE;
```

**前端业务逻辑**:

```typescript
// pages/activity-detail/index.tsx
useEffect(() => {
  if (activity) {
    let canSignup = true
    let reason = ''

    // 1. 检查活动状态
    if (activity.status === 'finished') {
      canSignup = false
      reason = '活动已结束'
    }

    // 2. 检查报名截止时间
    else if (activity.signup_deadline && new Date(activity.signup_deadline) < new Date()) {
      canSignup = false
      reason = '报名已截止'
    }

    // 3. 检查名额
    else if (activity.max_participants && activity.current_participants >= activity.max_participants) {
      canSignup = false
      reason = '名额已满'
    }

    // 4. 检查是否已报名
    else if (hasSignedUp) {
      canSignup = false
      reason = '您已报名此活动'
    }

    setCanSignup(canSignup)
    setSignupDisabledReason(reason)
  }
}, [activity, hasSignedUp])

// 报名按钮
<View
  className={`signup-btn ${!canSignup ? 'disabled' : ''}`}
  onClick={canSignup ? handleSignup : () => {
    Taro.showToast({ title: signupDisabledReason, icon: 'none' })
  }}
>
  <Text>{canSignup ? '立即报名' : signupDisabledReason}</Text>
</View>
```

**统一错误码处理**:

```typescript
// services/http.ts
const ERROR_CODE_MAP = {
  400: '请求参数有误',
  401: '未登录或登录已过期',
  403: '无权限访问',
  404: '请求的资源不存在',
  409: '操作冲突',
  500: '服务器异常，请稍后重试',
}

const BUSINESS_ERROR_MAP = {
  'SIGNUP_CLOSED': '报名已截止',
  'SIGNUP_FULL': '名额已满',
  'ALREADY_SIGNED_UP': '您已报名此活动',
  'ACTIVITY_FINISHED': '活动已结束',
  'PAYMENT_REQUIRED': '需要缴费才能报名',
}

api.interceptors.response.use(
  (response) => response,
  (error) => {
    const errorCode = error?.response?.status
    const businessCode = error?.response?.data?.code
    const message = BUSINESS_ERROR_MAP[businessCode]
      || ERROR_CODE_MAP[errorCode]
      || error?.response?.data?.detail
      || '请求失败，请稍后重试'
    Taro.showToast({ title: message, icon: 'none' })
    return Promise.reject(error)
  }
)
```

**验收标准**:
- [ ] 报名截止时间检查
- [ ] 名额已满检查
- [ ] 重复报名检查
- [ ] 活动状态检查
- [ ] 按钮禁用状态显示
- [ ] 错误提示明确

---

### 第二周总结

**关键产出**:
- ✅ 评论/评分功能完整实现
- ✅ 我的活动页面完整实现
- ✅ 业务错误处理完善

**风险点**:
- ⚠️ 评论功能可能需要审核机制（防止不良内容）
- ⚠️ "我的活动"页面可能需要额外的徽章/通知功能

---

## 第三周 (Week 3): 功能完善 - P2 优先

### 目标: 筛选功能 + 草稿保存 + UI 优化

#### D11-D12 - 报名列表筛选功能（第 11-12 天）

**任务**: 完善筛选器（城市、时间、状态）

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W3-D11-T1 | 后端支持筛选参数 | P2 | 1.5h | 待定 |
| W3-D11-T2 | 前端城市筛选组件 | P2 | 2h | 待定 |
| W3-D12-T1 | 前端时间筛选组件 | P2 | 2h | 待定 |
| W3-D12-T2 | 前端状态筛选组件 | P2 | 1.5h | 待定 |
| W3-D12-T3 | 筛选器联动逻辑 | P2 | 1h | 待定 |

**UI 设计**:

```
┌─────────────────────────────────────┐
│ 报名                               │
├─────────────────────────────────────┤
│ [搜索框]                     [筛选] │
│                                     │
│ 筛选器（展开状态）                  │
│ ┌───────────────────────────────┐   │
│ │ 城市: [全部▼] [长沙] [北京]  │   │
│ │ 时间: [本月▼] [下月] [未来3月]│   │
│ │ 状态: [全部▼] [报名中] [已结束]│  │
│ │ [重置] [确定]                 │   │
│ └───────────────────────────────┘   │
│                                     │
│ 已选筛选条件: 长沙 | 本月 | 报名中   │
│ [×]                                 │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 活动卡片 1                      │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**后端接口扩展**:

```python
GET /api/v1/activities
Query:
  - city: string[] (支持多选)
  - time_range: string (this_month/next_month/next_3_months/custom)
  - time_from: string (自定义开始时间)
  - time_to: string (自定义结束时间)
  - status: string[] (signup/ongoing/finished)
  - sort_by: string (start_time_asc/start_time_desc/created_at_desc)
```

**验收标准**:
- [ ] 城市筛选（支持多选）
- [ ] 时间筛选（本月/下月/未来3月/自定义）
- [ ] 状态筛选（报名中/进行中/已结束）
- [ ] 筛选器联动（选择条件后自动刷新列表）
- [ ] 已选条件展示（可点击删除）
- [ ] 重置筛选功能

---

#### D13 - 草稿保存功能（第 13 天）

**任务**: 报名表单自动保存草稿

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W3-D13-T1 | 草稿自动保存逻辑 | P2 | 2h | 待定 |
| W3-D13-T2 | 草稿恢复逻辑 | P2 | 1.5h | 待定 |
| W3-D13-T3 | 草稿管理 UI | P2 | 1.5h | 待定 |

**技术方案**:

```typescript
// hooks/useAutoSaveDraft.ts
export const useAutoSaveDraft = (activityId: number, formData: any) => {
  const DRAFT_KEY = `signup_draft_${activityId}`

  // 自动保存草稿（防抖 1 秒）
  useEffect(() => {
    const timer = setTimeout(() => {
      if (isFormDirty()) {
        Taro.setStorageSync(DRAFT_KEY, {
          data: formData,
          timestamp: Date.now(),
        })
      }
    }, 1000)
    return () => clearTimeout(timer)
  }, [formData])

  // 恢复草稿
  const loadDraft = useCallback(() => {
    const draft = Taro.getStorageSync(DRAFT_KEY)
    if (draft && Date.now() - draft.timestamp < 7 * 24 * 60 * 60 * 1000) {
      return draft.data
    }
    return null
  }, [])

  // 清除草稿
  const clearDraft = useCallback(() => {
    Taro.removeStorageSync(DRAFT_KEY)
  }, [])

  return { loadDraft, clearDraft }
}

// pages/signup/index.tsx
useEffect(() => {
  const draft = loadDraft()
  if (draft) {
    Taro.showModal({
      title: '发现未完成的报名',
      content: '是否恢复上次填写的内容？',
      success: (res) => {
        if (res.confirm) {
          setFormData(draft)
        } else {
          clearDraft()
        }
      }
    })
  }
}, [])
```

**验收标准**:
- [ ] 表单填写过程中自动保存（防抖 1 秒）
- [ ] 进入表单时检测草稿并询问是否恢复
- [ ] 草稿有效期 7 天
- [ ] 提交成功后自动清除草稿
- [ ] 用户主动退出时保留草稿

---

#### D14-D15 - UI 细节优化（第 14-15 天）

**任务**: 修复已知 UI 问题

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W3-D14-T1 | 报名表单弹窗高度优化 | P2 | 3h | 待定 |
| W3-D14-T2 | 报名表单圆角优化 | P2 | 1h | 待定 |
| W3-D15-T1 | 添加"选填"标识 | P2 | 1h | 待定 |
| W3-D15-T2 | 列表缓存机制 | P2 | 2h | 待定 |
| W3-D15-T3 | 图片懒加载 | P2 | 1h | 待定 |

**报名表单弹窗高度优化**:

```scss
// pages/signup/index.scss
.modal-card {
  // 1. 优化高度计算，避免与胶囊重合
  max-height: calc(100vh - #{$statusBarHeight} - 120rpx);

  // 2. 优化底部间距
  margin-bottom: 40rpx;

  // 3. 优化圆角
  border-radius: 32rpx 32rpx 24rpx 24rpx;
}

.card-actions {
  // 4. 固定按钮区高度
  height: 120rpx;
  padding: 16rpx 24rpx;
}

.form-scroll {
  // 5. 确保表单滚动区域高度合理
  height: calc(100% - 240rpx);
}
```

**列表缓存机制**:

```typescript
// utils/cache.ts
const CACHE_DURATION = 5 * 60 * 1000 // 5分钟

export const getCachedData = (key: string) => {
  const cached = Taro.getStorageSync(key)
  if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
    return cached.data
  }
  return null
}

export const setCachedData = (key: string, data: any) => {
  Taro.setStorageSync(key, {
    data,
    timestamp: Date.now(),
  })
}

// services/activities.ts
export const fetchActivityList = async (params) => {
  const cacheKey = `activity_list_${JSON.stringify(params)}`
  const cached = getCachedData(cacheKey)
  if (cached) return cached

  const response = await api.get('/activities', { params })
  setCachedData(cacheKey, response.data)
  return response.data
}
```

**图片懒加载**:

```tsx
// 统一替换所有 Image 组件
<Image
  src={activity.cover_url}
  mode="aspectFill"
  lazyLoad  // ✅ 添加懒加载
  className="cover-image"
/>
```

**验收标准**:
- [ ] 报名表单弹窗不与胶囊按钮重叠
- [ ] 表单内容与底部按钮间距固定
- [ ] 弹窗底部圆角正常显示
- [ ] 选填字段有明确标识
- [ ] 列表数据缓存 5 分钟
- [ ] 图片懒加载生效

---

### 第三周总结

**关键产出**:
- ✅ 报名列表筛选功能完整
- ✅ 草稿保存功能实现
- ✅ UI 细节优化完成

---

## 第四周 (Week 4): 测试与上线准备 - P0/P3

### 目标: 测试覆盖 + 性能优化 + 部署上线

#### D16-D17 - 核心业务测试（第 16-17 天）

**任务**: 单元测试 + 集成测试

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W4-D16-T1 | 后端核心服务测试 | P0 | 4h | 待定 |
| W4-D16-T2 | 后端 API 集成测试 | P0 | 3h | 待定 |
| W4-D17-T1 | 前端组件单元测试 | P0 | 4h | 待定 |
| W4-D17-T2 | 前端页面集成测试 | P0 | 3h | 待定 |

**后端测试示例**:

```python
# tests/services/test_signups.py
def test_signup_creation(db_session, mock_user, mock_activity):
    service = SignupService(db_session)
    payload = SignupCreate(
        activity_id=mock_activity.id,
        answers=[
            {"field_id": 1, "value_text": "张三"},
            {"field_id": 2, "value_text": "13800138000"},
        ]
    )
    result = service.create(payload, mock_user.id)
    assert result.status == SignupStatus.PENDING

def test_signup_approval(db_session, mock_signup, mock_admin):
    service = SignupService(db_session)
    result = service.review(
        mock_signup.id,
        mock_admin,
        SignupReviewRequest(action="approve", message="通过")
    )
    assert result.status == SignupStatus.APPROVED
```

**前端测试示例**:

```typescript
// pages/signup/__tests__/index.test.tsx
describe('SignupPage', () => {
  it('should validate required fields', async () => {
    const { getByText } = render(<SignupPage />)
    const nextButton = getByText('下一步')
    fireEvent.click(nextButton)
    await waitFor(() => {
      expect(getByText('请输入姓名')).toBeInTheDocument()
    })
  })

  it('should submit form successfully', async () => {
    const { getByText, getByPlaceholderText } = render(<SignupPage />)
    fireEvent.change(getByPlaceholderText('请输入姓名'), { target: { value: '张三' } })
    // ... 填写其他字段
    const submitButton = getByText('提交报名')
    fireEvent.click(submitButton)
    await waitFor(() => {
      expect(getByText('报名成功')).toBeInTheDocument()
    })
  })
})
```

**验收标准**:
- [ ] 后端核心服务单元测试覆盖率 > 70%
- [ ] 后端 API 集成测试通过
- [ ] 前端核心组件单元测试覆盖率 > 50%
- [ ] 前端关键页面集成测试通过

---

#### D18 - E2E 测试（第 18 天）

**任务**: 端到端测试（完整业务流程）

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W4-D18-T1 | 活动浏览流程测试 | P0 | 2h | 待定 |
| W4-D18-T2 | 报名流程测试 | P0 | 3h | 待定 |
| W4-D18-T3 | 互动功能测试 | P1 | 1.5h | 待定 |

**E2E 测试示例**:

```typescript
// e2e/signup-flow.spec.ts
test('complete signup flow', async ({ page }) => {
  // 1. 进入活动详情页
  await page.goto('/pages/activity-detail/index?id=1')
  await page.click('text=立即报名')

  // 2. 填写个人信息
  await page.fill('[placeholder="请输入姓名"]', '张三')
  await page.fill('[placeholder="请输入手机号"]', '13800138000')
  await page.click('text=下一步')

  // 3. 填写缴费信息
  await page.fill('[placeholder="请输入发票抬头"]', '某某公司')
  await page.fill('[placeholder="请输入邮箱"]', 'test@example.com')
  await page.click('text=下一步')

  // 4. 提交报名
  await page.click('text=提交报名')

  // 5. 验证成功页面
  await expect(page.locator('text=报名成功')).toBeVisible()
})
```

**验收标准**:
- [ ] 活动浏览流程测试通过
- [ ] 报名提交流程测试通过
- [ ] 互动功能测试通过
- [ ] 错误场景测试通过

---

#### D19 - 性能优化（第 19 天）

**任务**: 性能优化（P3 优先级较高的项目）

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W4-D19-T1 | 添加 useMemo/useCallback | P3 | 2h | 待定 |
| W4-D19-T2 | 长列表虚拟滚动 | P3 | 2h | 待定 |
| W4-D19-T3 | 性能监控埋点 | P3 | 2h | 待定 |

**性能优化示例**:

```typescript
// 1. 添加 useMemo
const DEFAULT_AGENDA = useMemo(() => [
  { id: 1, title: '开幕仪式', items: [...] },
  // ... 150+ 行的静态数据
], [])

// 2. 添加 useCallback
const validateStep = useCallback((): boolean => {
  const step = STEPS[currentStep]
  // ... 校验逻辑
}, [currentStep, formData])

// 3. 虚拟滚动
import VirtualList from '@tarojs/components/virtual-list'

const AgendaTab = ({ agenda }) => {
  return (
    <VirtualList
      height={600}
      itemData={agenda}
      itemCount={agenda.length}
      itemSize={80}
      width="100%"
    >
      {({ index, style }) => (
        <View style={style}>
          <AgendaItemCard item={agenda[index]} />
        </View>
      )}
    </VirtualList>
  )
}
```

---

#### D20 - 部署上线（第 20 天）

**任务**: 生产环境部署 + 上线检查

| 任务编号 | 任务名称 | 优先级 | 预估工时 | 负责人 |
|---------|---------|--------|---------|--------|
| W4-D20-T1 | 后端服务部署 | P0 | 2h | 待定 |
| W4-D20-T2 | 微信小程序发布 | P0 | 1.5h | 待定 |
| W4-D20-T3 | 域名配置 + SSL | P0 | 1.5h | 待定 |
| W4-D20-T4 | 上线前检查清单 | P0 | 1h | 待定 |

**上线检查清单**:

```markdown
## 后端检查
- [ ] 数据库备份
- [ ] 环境变量配置（生产环境）
- [ ] 微信 appid/secret 配置
- [ ] HTTPS 证书配置
- [ ] 日志监控配置
- [ ] 错误监控配置（Sentry）

## 前端检查
- [ ] CONFIG.USE_MOCK = false
- [ ] API_BASE_URL 配置为生产环境域名
- [ ] 微信小程序 appid 配置
- [ ] 版本号更新
- [ ] 隐私协议/用户协议链接

## 功能检查
- [ ] 活动浏览功能测试
- [ ] 搜索功能测试
- [ ] 报名提交功能测试
- [ ] 互动功能测试
- [ ] 我的活动功能测试
- [ ] 评论功能测试

## 安全检查
- [ ] 登录鉴权测试
- [ ] Token 刷新测试
- [ ] 敏感信息脱敏
- [ ] SQL 注入防护
- [ ] XSS 防护
```

---

### 第四周总结

**关键产出**:
- ✅ 核心业务测试覆盖率 > 50%
- ✅ E2E 测试通过
- ✅ 性能优化完成
- ✅ 生产环境部署完成

---

## 📊 总体统计

### 工时估算

| 阶段 | 时间 | 工时 | 主要任务 |
|------|------|------|---------|
| 第一周 | D1-D5 | 40h | 后端 API + 微信登录 + 联调 |
| 第二周 | D6-D10 | 40h | 评论/评分 + 我的活动 + 业务错误处理 |
| 第三周 | D11-D15 | 32h | 筛选功能 + 草稿保存 + UI 优化 |
| 第四周 | D16-D20 | 32h | 测试 + 性能优化 + 部署上线 |
| **总计** | **20天** | **144h** | **约 3.6 人周** |

### 任务分布

```
总任务数: 60+
  - P0 (阻塞上线): 20 项 (33%)
  - P1 (影响体验): 18 项 (30%)
  - P2 (功能完善): 15 项 (25%)
  - P3 (优化改进): 7 项 (12%)
```

### 依赖关系

```
Week 1 (后端 API + 登录)
  ↓
Week 2 (评论/我的活动) - 依赖 Week 1 的登录鉴权
  ↓
Week 3 (筛选 + 优化) - 依赖 Week 1 的 API
  ↓
Week 4 (测试 + 上线) - 依赖 Week 1-3 的所有功能
```

---

## ⚠️ 风险与应对

### 高风险点

| 风险项 | 风险等级 | 影响 | 应对措施 |
|--------|---------|------|---------|
| 后端 API 开发延期 | 🔴 高 | 阻塞前后端联调 | 1. 前端继续用 Mock 开发<br>2. 后端并行开发<br>3. 预留 2 天缓冲时间 |
| 微信小程序配置问题 | 🟡 中 | 影响登录功能 | 1. 提前准备 appid/secret<br>2. 提前测试登录流程 |
| 测试覆盖率不足 | 🟡 中 | 影响代码质量 | 1. 优先测试核心业务<br>2. 可延后非核心功能测试 |
| 性能问题 | 🟢 低 | 影响用户体验 | 1. 先上线基础版本<br>2. 后续迭代优化 |

### 应急预案

**如果第一周后端 API 未完成**:
- Plan B: 延长 Mock 模式开发，继续完成前端功能
- 调整: Week 2 继续开发评论/我的活动（用 Mock）
- 联调: Week 3 集中进行前后端联调

**如果微信登录鉴权有问题**:
- Plan B: 临时使用测试账号模式（跳过微信登录）
- 调整: 后续迭代修复微信登录
- 影响: 无法识别真实用户，但不影响功能演示

**如果测试时间不足**:
- Plan B: 优先测试核心流程（活动浏览 + 报名）
- 调整: 非核心功能（评论、筛选）延后测试
- 影响: 可能存在边缘 Bug，但不影响主流程

---

## 📝 验收标准

### MVP 版本验收标准 (第四周结束时)

#### 功能完整性
- [ ] ✅ 用户可以浏览活动列表（首页、搜索、列表页）
- [ ] ✅ 用户可以查看活动详情（速览、议程、酒店、直播）
- [ ] ✅ 用户可以报名活动（完整表单流程）
- [ ] ✅ 用户可以添加同行人员
- [ ] ✅ 用户可以查看我的报名记录
- [ ] ✅ 用户可以收藏/点赞/分享活动
- [ ] ✅ 用户可以发布评论/评分
- [ ] ✅ 微信登录鉴权正常

#### 性能指标
- [ ] 首页加载时间 < 2s
- [ ] 活动详情页加载时间 < 3s
- [ ] 报名提交响应时间 < 1s
- [ ] 搜索响应时间 < 1s

#### 稳定性指标
- [ ] 核心业务流程测试通过率 100%
- [ ] 单元测试覆盖率 > 50%
- [ ] E2E 测试通过率 100%
- [ ] 无 P0/P1 级别 Bug

#### 用户体验
- [ ] 双主题适配完整
- [ ] 错误提示友好明确
- [ ] Loading 状态完善
- [ ] 空状态提示清晰
- [ ] 表单校验完善

---

## 🔄 后续迭代规划 (Week 5+)

### 第五周: 技术债务清理

**目标**: 提升代码质量

- [ ] 消除 TypeScript `any` 类型（从 150+ 降至 < 50）
- [ ] 抽取重复组件为共享组件
- [ ] 完善代码注释和文档
- [ ] 统一配置管理

**预估工时**: 24h

### 第六周: 性能优化

**目标**: 提升用户体验

- [ ] 添加全局性能监控
- [ ] 优化长列表渲染（虚拟滚动）
- [ ] 优化图片加载（懒加载 + CDN）
- [ ] 优化请求缓存（SWR/React Query）

**预估工时**: 16h

### 第七周: 功能扩展

**目标**: 增加新功能

- [ ] 活动推荐算法（基于用户历史）
- [ ] 消息通知功能（报名审核结果）
- [ ] 徽章系统（首次参会、多次参会）
- [ ] 数据统计面板（管理后台）

**预估工时**: 32h

---

## 📚 附录

### A. 关键接口清单

| 接口 | Method | 用途 | 优先级 | 完成状态 |
|------|--------|------|--------|----------|
| `/api/v1/activities` | GET | 获取活动列表 | P0 | ⚠️ 待开发 |
| `/api/v1/activities/featured` | GET | 获取热门精选 | P0 | ⚠️ 待开发 |
| `/api/v1/activities/:id` | GET | 获取活动详情 | P0 | ⚠️ 待开发 |
| `/api/v1/registrations` | POST | 提交报名 | P0 | ⚠️ 待开发 |
| `/api/v1/signups/:id/companions` | POST | 添加同行人员 | P0 | ⚠️ 待开发 |
| `/api/v1/auth/wechat/login` | POST | 微信登录 | P0 | ⚠️ 待开发 |
| `/api/v1/auth/refresh` | POST | Token 刷新 | P0 | ⚠️ 待开发 |
| `/api/v1/wechat/decrypt-phone` | POST | 微信手机号解密 | P0 | ⚠️ 待开发 |
| `/api/v1/engagements/:id/favorite` | POST/DELETE | 收藏/取消收藏 | P1 | ⚠️ 待开发 |
| `/api/v1/engagements/:id/like` | POST/DELETE | 点赞/取消点赞 | P1 | ⚠️ 待开发 |
| `/api/v1/engagements/:id/share` | POST | 记录分享 | P1 | ⚠️ 待开发 |
| `/api/v1/activities/:id/comments` | GET | 获取评论列表 | P1 | ⚠️ 待开发 |
| `/api/v1/activities/:id/comments` | POST | 发布评论 | P1 | ⚠️ 待开发 |
| `/api/v1/users/me/signups` | GET | 我的报名列表 | P1 | ⚠️ 待开发 |
| `/api/v1/signups/:id` | GET | 报名详情 | P1 | ⚠️ 待开发 |

### B. 数据库字段补充清单

```sql
-- activities 表补充字段
ALTER TABLE activities ADD COLUMN city VARCHAR(50);
ALTER TABLE activities ADD COLUMN is_free BOOLEAN DEFAULT TRUE;
ALTER TABLE activities ADD COLUMN price DECIMAL(10, 2) DEFAULT 0;
ALTER TABLE activities ADD COLUMN agenda JSON;
ALTER TABLE activities ADD COLUMN avg_rating DECIMAL(3, 2) DEFAULT 0;
ALTER TABLE activities ADD COLUMN signup_count INTEGER DEFAULT 0;
ALTER TABLE activities ADD COLUMN signup_deadline TIMESTAMP;
ALTER TABLE activities ADD COLUMN max_participants INTEGER;
ALTER TABLE activities ADD COLUMN current_participants INTEGER DEFAULT 0;
ALTER TABLE activities ADD COLUMN allow_signup_during_event BOOLEAN DEFAULT FALSE;

-- 创建 comments 表
CREATE TABLE comments (
  id SERIAL PRIMARY KEY,
  activity_id INTEGER NOT NULL REFERENCES activities(id),
  user_id INTEGER NOT NULL REFERENCES users(id),
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  content TEXT,
  parent_id INTEGER REFERENCES comments(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_comments_activity_id ON comments(activity_id);
CREATE INDEX idx_comments_user_id ON comments(user_id);
```

### C. 配置文件清单

**后端配置** (`backend/.env`):
```bash
# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/activity_signup

# 微信小程序
WECHAT_APPID=your_appid_here
WECHAT_SECRET=your_secret_here
WECHAT_MOCK_ENABLED=false

# JWT
SECRET_KEY=your_secret_key_here_at_least_32_chars
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=30

# 环境
ENVIRONMENT=production
```

**前端配置** (`frontend/app/config/index.ts`):
```typescript
export const CONFIG = {
  USE_MOCK: false,
  API_BASE_URL: 'https://your-api-domain.com/api/v1',
  WECHAT_APPID: 'your_appid_here',
}
```

### D. 团队分工建议

| 角色 | 负责模块 | 关键任务 |
|------|---------|---------|
| 后端开发 A | API 开发 | Week 1-2 接口开发 |
| 后端开发 B | 测试 + 部署 | Week 3-4 测试 + 部署 |
| 前端开发 A | 评论 + 我的活动 | Week 2 新功能开发 |
| 前端开发 B | 筛选 + 优化 | Week 3 功能完善 |
| 全栈开发 | 联调 + 测试 | Week 1、Week 4 联调测试 |

---

## 🎉 总结

本规划文档基于业务流程检查报告和技术债务报告，制定了详细的 4 周开发计划。

**核心目标**: 在 4 周内完成可上线的 MVP 版本

**关键里程碑**:
- Week 1: 后端 API + 微信登录
- Week 2: 评论/评分 + 我的活动
- Week 3: 筛选 + 草稿保存 + UI 优化
- Week 4: 测试 + 性能优化 + 部署上线

**成功指标**:
- 后端 API 开发完成度: 100%
- 微信登录鉴权完成度: 100%
- 核心业务流程测试通过率: 100%
- 测试覆盖率: 从 < 5% 提升至 50%+

**下一步行动**:
1. 组织团队 Kickoff 会议，讲解规划内容
2. 分配任务到具体负责人
3. 创建项目管理看板（Jira/Trello）
4. 开始 Week 1 的开发工作

---

**文档维护**: 每周更新一次，记录实际进度和调整

**反馈渠道**: 如有问题或建议，请及时同步团队

**祝开发顺利！** 🚀
